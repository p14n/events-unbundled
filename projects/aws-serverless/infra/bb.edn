{:paths ["clj"]
 :min-bb-version "0.4.0"
 :deps {functions/functions {:local/root "../../../functions"}}
 :tasks
 {:requires ([infra :as inf]
             [lambda-handlers :as lh]
             [cheshire.core :as json]
             [clojure.string :as str])


  synth {:doc "Creates terraform"
         :task (->> (json/generate-string (inf/synth lh/all) {:pretty true})
                    (spit "transient.tf.json"))}
  zip-lambda {:doc "Zips lambda"
              :task (shell {:dir "../lambda"} "zip -FSr lambda.zip .")}

  zip-gql {:doc "Zips graphql"
           :task (shell {:dir "../graphql"} "zip -FSr graphql.zip .")}

  build {:doc "Creates terraform and zips lambda"
         :depends [synth zip-lambda zip-gql]}

  tf {:doc "Builds and runs terraform"
      :depends [build]
      :task (shell (str "terraform " (str/join " " *command-line-args*)))}}}


